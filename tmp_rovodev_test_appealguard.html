<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppealGuard Test</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: #f9fafb;
        }
        .test-section {
            background: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #1e3a5f;
            margin-bottom: 1rem;
        }
        .status {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .status.pending {
            background: #fef3c7;
            color: #92400e;
        }
        button {
            padding: 0.75rem 1.5rem;
            background: #1e3a5f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover {
            background: #2d5a8e;
        }
        .code-block {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            margin: 1rem 0;
            white-space: pre-wrap;
        }
        .output {
            background: #f9fafb;
            padding: 1rem;
            border-left: 4px solid #3b82f6;
            margin: 1rem 0;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è AppealGuard Integration Test Suite</h1>
    
    <!-- Module Loading Tests -->
    <div class="test-section">
        <h2>1. Module Loading Tests</h2>
        <div id="module-status">
            <span class="status pending">Checking...</span>
        </div>
        <button onclick="testModuleLoading()">Run Module Tests</button>
        <div id="module-output" class="output" style="display:none;"></div>
    </div>

    <!-- State Management Tests -->
    <div class="test-section">
        <h2>2. State Management Tests</h2>
        <div id="state-status">
            <span class="status pending">Not Run</span>
        </div>
        <button onclick="testStateManagement()">Test State</button>
        <div id="state-output" class="output" style="display:none;"></div>
    </div>

    <!-- UI Generation Tests -->
    <div class="test-section">
        <h2>3. UI Wizard Generation</h2>
        <div id="ui-status">
            <span class="status pending">Not Run</span>
        </div>
        <button onclick="testUIGeneration()">Generate UI</button>
        <div id="ui-output" class="output" style="display:none;"></div>
    </div>

    <!-- AI Generation Test -->
    <div class="test-section">
        <h2>4. AI Generation Test (Mock)</h2>
        <div id="ai-status">
            <span class="status pending">Not Run</span>
        </div>
        <button onclick="testAIGeneration()">Test AI (Mock)</button>
        <div id="ai-output" class="output" style="display:none;"></div>
        
        <h3 style="margin-top: 2rem;">Real AI Test (Requires Puter Auth)</h3>
        <button onclick="testRealAI()">Test Real AI Generation</button>
        <div id="real-ai-output" class="output" style="display:none;"></div>
    </div>

    <!-- Integration Test -->
    <div class="test-section">
        <h2>5. Full Integration Test</h2>
        <div id="integration-status">
            <span class="status pending">Not Run</span>
        </div>
        <button onclick="testFullIntegration()">Run Full Test</button>
        <div id="integration-output" class="output" style="display:none;"></div>
    </div>

    <!-- Load AppealGuard Modules -->
    <script src="appeal-response-writer.js"></script>
    <script src="appeal-ai-engine.js"></script>
    <script src="appeal-display.js"></script>

    <script>
        // Test 1: Module Loading
        function testModuleLoading() {
            const output = document.getElementById('module-output');
            const status = document.getElementById('module-status');
            output.style.display = 'block';
            output.innerHTML = '<strong>Running Module Tests...</strong><br><br>';
            
            let allPassed = true;
            const tests = [
                { name: 'appeal-response-writer.js', check: () => typeof window.appealCommandHandler === 'function' },
                { name: 'appeal-ai-engine.js', check: () => typeof window.generateAppealWithAI === 'function' },
                { name: 'appeal-display.js', check: () => typeof window.displayGeneratedAppeal === 'function' },
                { name: 'setAppealType function', check: () => typeof window.setAppealType === 'function' },
                { name: 'setAppealTone function', check: () => typeof window.setAppealTone === 'function' },
                { name: 'setAppealModel function', check: () => typeof window.setAppealModel === 'function' },
                { name: 'generateAppeal function', check: () => typeof window.generateAppeal === 'function' },
                { name: 'copyAppealToClipboard function', check: () => typeof window.copyAppealToClipboard === 'function' },
                { name: 'saveAppealToPuter function', check: () => typeof window.saveAppealToPuter === 'function' },
                { name: 'insertAppealToDocument function', check: () => typeof window.insertAppealToDocument === 'function' }
            ];

            tests.forEach(test => {
                const passed = test.check();
                output.innerHTML += `${passed ? '‚úÖ' : '‚ùå'} ${test.name}: ${passed ? 'LOADED' : 'MISSING'}<br>`;
                if (!passed) allPassed = false;
            });

            status.innerHTML = allPassed 
                ? '<span class="status success">‚úÖ All Modules Loaded</span>'
                : '<span class="status error">‚ùå Some Modules Failed</span>';
        }

        // Test 2: State Management
        function testStateManagement() {
            const output = document.getElementById('state-output');
            const status = document.getElementById('state-status');
            output.style.display = 'block';
            output.innerHTML = '<strong>Testing State Management...</strong><br><br>';

            let allPassed = true;

            // Test initial state
            if (window.appealState) {
                output.innerHTML += '‚úÖ appealState exists<br>';
                output.innerHTML += `State: ${JSON.stringify(window.appealState, null, 2)}<br><br>`;
            } else {
                output.innerHTML += '‚ùå appealState not found<br>';
                allPassed = false;
            }

            // Test setAppealType
            try {
                window.setAppealType('misconduct');
                output.innerHTML += '‚úÖ setAppealType("misconduct") successful<br>';
                output.innerHTML += `New type: ${window.appealState.type}<br><br>`;
            } catch (e) {
                output.innerHTML += `‚ùå setAppealType failed: ${e.message}<br>`;
                allPassed = false;
            }

            // Test setAppealTone
            try {
                window.setAppealTone('contrite');
                output.innerHTML += '‚úÖ setAppealTone("contrite") successful<br>';
                output.innerHTML += `New tone: ${window.appealState.tone}<br><br>`;
            } catch (e) {
                output.innerHTML += `‚ùå setAppealTone failed: ${e.message}<br>`;
                allPassed = false;
            }

            // Test setAppealModel
            try {
                window.setAppealModel('claude-3.5-sonnet');
                output.innerHTML += '‚úÖ setAppealModel("claude-3.5-sonnet") successful<br>';
                output.innerHTML += `New model: ${window.appealState.selectedModel}<br>`;
            } catch (e) {
                output.innerHTML += `‚ùå setAppealModel failed: ${e.message}<br>`;
                allPassed = false;
            }

            status.innerHTML = allPassed 
                ? '<span class="status success">‚úÖ State Tests Passed</span>'
                : '<span class="status error">‚ùå State Tests Failed</span>';
        }

        // Test 3: UI Generation
        function testUIGeneration() {
            const output = document.getElementById('ui-output');
            const status = document.getElementById('ui-status');
            output.style.display = 'block';
            output.innerHTML = '<strong>Generating UI...</strong><br><br>';

            try {
                // Mock appendNotionMessage
                const originalAppend = window.appendNotionMessage;
                let capturedUI = '';
                
                window.appendNotionMessage = function(msg) {
                    capturedUI = msg.content;
                };

                // Trigger wizard
                if (window.appealCommandHandler) {
                    window.appealCommandHandler('/appeal start');
                }

                // Restore original
                if (originalAppend) {
                    window.appendNotionMessage = originalAppend;
                }

                if (capturedUI && capturedUI.includes('AppealGuard')) {
                    output.innerHTML += '‚úÖ UI Generated Successfully<br><br>';
                    output.innerHTML += '<strong>Generated HTML Preview:</strong><br>';
                    output.innerHTML += `<div style="border:1px solid #ccc; padding:1rem; max-height:300px; overflow:auto;">${capturedUI}</div>`;
                    status.innerHTML = '<span class="status success">‚úÖ UI Generated</span>';
                } else {
                    output.innerHTML += '‚ùå UI generation failed or incomplete<br>';
                    status.innerHTML = '<span class="status error">‚ùå UI Failed</span>';
                }
            } catch (e) {
                output.innerHTML += `‚ùå Error: ${e.message}<br>`;
                status.innerHTML = '<span class="status error">‚ùå Error</span>';
            }
        }

        // Test 4: Mock AI Generation
        function testAIGeneration() {
            const output = document.getElementById('ai-output');
            const status = document.getElementById('ai-status');
            output.style.display = 'block';
            output.innerHTML = '<strong>Testing AI Generation Logic (Mock)...</strong><br><br>';

            // Set test data
            window.appealState = {
                type: 'misconduct',
                tone: 'contrite',
                institution: 'Test University',
                allegation: 'Test Plagiarism Case',
                rawInput: 'This is a test explanation of what happened.',
                selectedModel: 'claude-3.5-sonnet',
                currentDraft: '',
                history: []
            };

            output.innerHTML += '‚úÖ Test state configured<br>';
            output.innerHTML += `Type: ${window.appealState.type}<br>`;
            output.innerHTML += `Tone: ${window.appealState.tone}<br>`;
            output.innerHTML += `Model: ${window.appealState.selectedModel}<br><br>`;

            output.innerHTML += '<strong>Note:</strong> Real AI generation requires Puter authentication. Use "Test Real AI Generation" button for actual test.<br>';
            
            status.innerHTML = '<span class="status success">‚úÖ Logic Ready</span>';
        }

        // Test 5: Real AI Generation
        async function testRealAI() {
            const output = document.getElementById('real-ai-output');
            output.style.display = 'block';
            output.innerHTML = '<strong>Running Real AI Generation Test...</strong><br><br>';

            // Check Puter
            if (typeof puter === 'undefined') {
                output.innerHTML += '‚ùå Puter.js not loaded<br>';
                return;
            }

            // Set test data
            window.appealState = {
                type: 'misconduct',
                tone: 'contrite',
                institution: 'Test University',
                allegation: 'Unintentional citation error in essay',
                rawInput: 'I made a mistake in my essay. I forgot to properly cite a source because I was stressed about my sick grandmother. I understand this was wrong and I have learned from this experience. I attended a citation workshop and will be more careful in the future.',
                selectedModel: 'claude-3.5-sonnet',
                currentDraft: '',
                history: []
            };

            output.innerHTML += '‚úÖ Test data configured<br>';
            output.innerHTML += '‚è≥ Generating appeal with AI...<br><br>';

            try {
                const result = await window.generateAppealWithAI();
                output.innerHTML += '‚úÖ <strong>AI Generation Successful!</strong><br><br>';
                output.innerHTML += '<strong>Generated Appeal Letter:</strong><br>';
                output.innerHTML += `<pre style="background:#f3f4f6; padding:1rem; border-radius:6px; white-space:pre-wrap;">${result}</pre>`;
            } catch (error) {
                output.innerHTML += `‚ùå AI Generation Failed: ${error.message}<br>`;
                output.innerHTML += `<pre>${error.stack}</pre>`;
            }
        }

        // Test 6: Full Integration
        async function testFullIntegration() {
            const output = document.getElementById('integration-output');
            const status = document.getElementById('integration-status');
            output.style.display = 'block';
            output.innerHTML = '<strong>Running Full Integration Test...</strong><br><br>';

            let allPassed = true;

            // Test 1: Command handler
            try {
                output.innerHTML += '<strong>1. Testing Command Handler...</strong><br>';
                if (typeof window.appealCommandHandler === 'function') {
                    output.innerHTML += '‚úÖ Command handler exists<br>';
                } else {
                    output.innerHTML += '‚ùå Command handler missing<br>';
                    allPassed = false;
                }
            } catch (e) {
                output.innerHTML += `‚ùå Error: ${e.message}<br>`;
                allPassed = false;
            }

            // Test 2: State initialization
            output.innerHTML += '<br><strong>2. Testing State Initialization...</strong><br>';
            try {
                window.setAppealType('financial');
                window.setAppealTone('desperate');
                window.setAppealModel('gemini-3-pro-preview');
                
                if (window.appealState.type === 'financial' &&
                    window.appealState.tone === 'desperate' &&
                    window.appealState.selectedModel === 'gemini-3-pro-preview') {
                    output.innerHTML += '‚úÖ State management working<br>';
                } else {
                    output.innerHTML += '‚ùå State management failed<br>';
                    allPassed = false;
                }
            } catch (e) {
                output.innerHTML += `‚ùå Error: ${e.message}<br>`;
                allPassed = false;
            }

            // Test 3: Display functions
            output.innerHTML += '<br><strong>3. Testing Display Functions...</strong><br>';
            const displayTests = [
                'displayGeneratedAppeal',
                'copyAppealToClipboard',
                'saveAppealToPuter',
                'insertAppealToDocument',
                'refineAppeal'
            ];

            displayTests.forEach(func => {
                if (typeof window[func] === 'function') {
                    output.innerHTML += `‚úÖ ${func} available<br>`;
                } else {
                    output.innerHTML += `‚ùå ${func} missing<br>`;
                    allPassed = false;
                }
            });

            output.innerHTML += '<br><strong>Integration Test Summary:</strong><br>';
            if (allPassed) {
                output.innerHTML += '‚úÖ All integration tests passed!<br>';
                output.innerHTML += '<br><strong>AppealGuard is ready to use!</strong><br>';
                status.innerHTML = '<span class="status success">‚úÖ Integration Complete</span>';
            } else {
                output.innerHTML += '‚ùå Some integration tests failed<br>';
                status.innerHTML = '<span class="status error">‚ùå Integration Issues</span>';
            }
        }

        // Auto-run module loading test on page load
        window.addEventListener('load', () => {
            setTimeout(testModuleLoading, 500);
        });
    </script>
</body>
</html>
